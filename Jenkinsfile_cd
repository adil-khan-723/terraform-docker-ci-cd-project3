pipeline {
    agent any

    environment {
        AWS_REGION      = "ap-south-1"
        AWS_ACCOUNT_ID  = "736786104206"
        ASSUME_ROLE_ARN = "arn:aws:iam::736786104206:role/ci-ecr-push-role-dev"
    }

    stages {

        stage("Checkout infra repo") {
            steps {
                git branch: 'main',
                    changelog: false,
                    poll: false,
                    url: 'https://github.com/adil-khan-723/terraform-docker-infra-code-project3.git'
            }
        }

        stage("Fetch image tags from CI (upstream)") {
            steps {
                copyArtifacts(
                    projectName: 'ci',
                    selector: lastSuccessful(),
                    filter: 'image-tags.env'
                )
            }
        }

        stage("Load image tags into environment") {
            steps {
                sh '''
                  set -a
                  source image-tags.env
                  set +a

                  echo "Backend image tag  : $BACKEND_IMAGE_TAG"
                  echo "Frontend image tag : $FRONTEND_IMAGE_TAG"
                '''
            }
        }

        stage("Assume deploy role") {
            steps {
                script {
                    def creds = sh(
                        script: """
                          aws sts assume-role \
                            --role-arn ${ASSUME_ROLE_ARN} \
                            --role-session-name jenkins-cd-session \
                            --output json
                        """,
                        returnStdout: true
                    ).trim()

                    def json = readJSON text: creds

                    env.AWS_ACCESS_KEY_ID     = json.Credentials.AccessKeyId
                    env.AWS_SECRET_ACCESS_KEY = json.Credentials.SecretAccessKey
                    env.AWS_SESSION_TOKEN     = json.Credentials.SessionToken
                }
            }
        }

        stage("Terraform init") {
            steps {
                sh 'terraform init'
            }
        }

        stage("Terraform apply") {
            steps {
                sh """
                  terraform apply -auto-approve \
                    -var="backend_image_tag=$BACKEND_IMAGE_TAG" \
                    -var="frontend_image_tag=$FRONTEND_IMAGE_TAG" \
                    -var-file=./env/dev.tfvars
                """
            }
        }
    }

    post {
        success {
            echo "CD successful â€” backend=$BACKEND_IMAGE_TAG frontend=$FRONTEND_IMAGE_TAG"
        }
        failure {
            echo "CD failed"
        }
    }
}